{"version":3,"file":"Application.js","sourceRoot":"","sources":["../src/Application.ts"],"names":[],"mappings":"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","sourcesContent":["import uWS from \"uWebSockets.js\";\nimport EventEmitter from \"events\";\nimport express, { NextFunction, application } from \"express\";\n\n// import pathToRegexp from \"path-to-regexp\";\n\nimport { IncomingMessage } from \"./IncomingMessage\";\nimport { ServerResponse } from \"./ServerResponse\";\n\nfunction getUrlParameters (url: string) {\n  return (url.match(/:([a-zA-Z0-9\\_]+)/gi) || []).map((param) => param.substr(1));\n}\n\nfunction onAbort(req: IncomingMessage, res: ServerResponse) {\n  req.socket.readable = false;\n  res.finished = true;\n  res.aborted = true;\n}\n\ntype RequestHandler = (req: IncomingMessage, res: ServerResponse, next?: NextFunction) => void;\ntype MiddlewareList = Array<{ regexp?: RegExp, handler: RequestHandler }>;\n\nexport type RenderCallback = (e: any, rendered?: string) => void;\ntype EngineCallback = (path: string, options: object, callback: RenderCallback) => void;\n\n// const rootRegexpPath = pathToRegexp(\"/\", [], { end: false, strict: false });\n\nexport class Application extends EventEmitter {\n  // middlewares: MiddlewareList = [];\n\n  // engines: {[ext: string]: EngineCallback} = {};\n  // settings: {[setting: string]: any} = {};\n  // cache: {[id: string]: any} = {};\n\n  protected listeningSocket: any = undefined;\n\n  protected request = express.request;\n  protected response = express.response;\n\n  private _router: any;\n\n  constructor(protected uWSApp: uWS.TemplatedApp) {\n    super();\n\n    // Alias app.delete() = app.del()\n    uWSApp['delete'] = uWSApp['del'];\n\n    this.init();\n  }\n\n  protected init() {\n    // perform original express initialization\n    application.init.apply(this, arguments);\n\n    this.uWSApp.any(\"/*\", async (uwsResponse, uwsRequest) => {\n      const url = uwsRequest.getUrl();\n\n      const req = new IncomingMessage(uwsRequest, uwsResponse, [], this);\n      const res = new ServerResponse(uwsResponse, req, this);\n\n      uwsResponse.onAborted(onAbort.bind(undefined, req, res));\n\n      // read body data!\n      if (req.headers['content-length']) {\n        try {\n          await req['readBody']();\n        } catch (e) {\n          console.warn(\"uWebSockets-express: failed reading request body at\", url);\n        }\n      }\n\n      this.handle(req, res);\n    });\n  }\n\n  protected handle(req, res, callback?) {\n    (express.application as any).handle.call(this, req, res, callback);\n  }\n\n  protected lazyrouter() {\n    // DISCARDED: original lazyrouter auto-initializes \"expressInit\", which\n    // overrides the prototype of request/response, which we can't let happen\n    // (express.application as any).lazyrouter.apply(this, arguments);\n\n    if (!this._router) {\n      this._router = express.Router({\n        caseSensitive: this.enabled('case sensitive routing'),\n        strict: this.enabled('strict routing')\n      });\n\n      this._router.use(express.query(this.get('query parser fn')));\n\n      const app = this;\n      this._router.use(function expressInit(req, res, next) {\n        if (app.enabled('x-powered-by')) res.setHeader('X-Powered-By', 'Express');\n        req.res = res;\n        res.req = req;\n        req.next = next;\n\n        // setPrototypeOf(req, app.request)\n        // setPrototypeOf(res, app.response)\n\n        res.locals = res.locals || Object.create(null);\n\n        next();\n      });\n    }\n\n    return ;\n  }\n\n  public engine(ext: string, fn: EngineCallback) {\n    application.engine.apply(this, arguments);\n  }\n\n  public set(setting, val) {\n    return application.set.apply(this, arguments);\n  }\n\n  public enable(setting: string) {\n    return application.enable.call(this, setting);\n  }\n\n  public enabled(setting: string) {\n    return application.enabled.call(this, setting);\n  }\n\n  public render(name: string, options: any, callback: RenderCallback) {\n    return application.render.apply(this, arguments);\n  }\n\n  public use(handler: RequestHandler)\n  public use(path: string, handler: RequestHandler)\n  public use(path: string, router: express.Router)\n  public use(path: string, ...handlers: Array<express.Router | RequestHandler>)\n  public use(path: string, any: any)\n  public use(any: any)\n  public use(pathOrHandler: string | RequestHandler, ...handlersOrRouters: Array<RequestHandler | express.Router>) {\n    express.application.use.apply(this, arguments);\n    return this;\n  }\n\n  public get(path: string, ...handlers: RequestHandler[]) {\n    return express.application.get.apply(this, arguments);\n  }\n\n  public post(path: string, ...handlers: RequestHandler[]) {\n    express.application.post.apply(this, arguments);\n    return this;\n  }\n\n  public patch(path: string, ...handlers: RequestHandler[]) {\n    express.application.patch.apply(this, arguments);\n    return this;\n  }\n\n  public options(path: string, ...handlers: RequestHandler[]) {\n    express.application.options.apply(this, arguments);\n    return this;\n  }\n\n  public put(path: string, ...handlers: RequestHandler[]) {\n    express.application.put.apply(this, arguments);\n    return this;\n  }\n\n  /**\n   * @deprecated\n   */\n  public del(path: string, ...handlers: RequestHandler[]) {\n    return this.delete.apply(this, arguments);\n  }\n\n  public delete(path: string, ...handlers: RequestHandler[]) {\n    express.application.delete.apply(this, arguments);\n    return this;\n  }\n\n  public head(path: string, ...handlers: RequestHandler[]) {\n    express.application.head.apply(this, arguments);\n    return this;\n  }\n\n  public all(path: string, ...handlers: RequestHandler[]) {\n    express.application.all.apply(this, arguments);\n    return this;\n  }\n\n  public listen(port?: number, cb?: () => void) {\n    this.uWSApp.listen(port, (listenSocket: any) => {\n      this.listeningSocket = listenSocket;\n      cb?.();\n    });\n\n    const self = this;\n    return {\n      close() {\n        uWS.us_listen_socket_close(self.listeningSocket);\n        self.listeningSocket = null;\n      }\n    };\n  }\n\n  protected defaultConfiguration() {\n    application.defaultConfiguration.apply(this);\n  }\n\n}\n\n"]}