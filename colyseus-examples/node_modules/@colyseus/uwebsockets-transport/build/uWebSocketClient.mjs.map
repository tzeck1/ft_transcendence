{"version":3,"file":"uWebSocketClient.mjs","sources":["../src/uWebSocketClient.ts"],"sourcesContent":["import EventEmitter from 'events';\nimport uWebSockets from 'uWebSockets.js';\n\nimport { getMessageBytes, Protocol, Client, ClientState, ISendOptions } from '@colyseus/core';\nimport { Schema } from '@colyseus/schema';\n\nexport class uWebSocketWrapper extends EventEmitter {\n  constructor(public ws: uWebSockets.WebSocket) {\n    super();\n  }\n}\n\nexport enum ReadyState {\n  CONNECTING = 0,\n  OPEN = 1,\n  CLOSING = 2,\n  CLOSED = 3,\n}\n\nexport class uWebSocketClient implements Client {\n  public sessionId: string;\n  public state: ClientState = ClientState.JOINING;\n  public _enqueuedMessages: any[] = [];\n  public _afterNextPatchQueue;\n  public readyState: number = ReadyState.OPEN;\n\n  constructor(\n    public id: string,\n    public _ref: uWebSocketWrapper,\n  ) {\n    this.sessionId = id;\n\n    _ref.on('close', () => this.readyState = ReadyState.CLOSED);\n  }\n\n  get ref() { return this._ref; }\n  set ref(_ref: uWebSocketWrapper) {\n    this._ref = _ref;\n    this.readyState = ReadyState.OPEN;\n  }\n\n  public send(messageOrType: any, messageOrOptions?: any | ISendOptions, options?: ISendOptions) {\n    this.enqueueRaw(\n      (messageOrType instanceof Schema)\n        ? getMessageBytes[Protocol.ROOM_DATA_SCHEMA](messageOrType)\n        : getMessageBytes[Protocol.ROOM_DATA](messageOrType, messageOrOptions),\n      options,\n    );\n  }\n\n  public enqueueRaw(data: ArrayLike<number>, options?: ISendOptions) {\n    // use room's afterNextPatch queue\n    if (options?.afterNextPatch) {\n      this._afterNextPatchQueue.push([this, arguments]);\n      return;\n    }\n\n    if (this.state === ClientState.JOINING) {\n      // sending messages during `onJoin`.\n      // - the client-side cannot register \"onMessage\" callbacks at this point.\n      // - enqueue the messages to be send after JOIN_ROOM message has been sent\n      this._enqueuedMessages.push(data);\n      return;\n    }\n\n    this.raw(data, options);\n  }\n\n  public raw(data: ArrayLike<number>, options?: ISendOptions, cb?: (err?: Error) => void) {\n    if (this.readyState !== ReadyState.OPEN) {\n      console.warn('trying to send data to inactive client', this.sessionId);\n      return;\n    }\n\n    this._ref.ws.send(new Uint8Array(data), true, false);\n  }\n\n  public error(code: number, message: string = '', cb?: (err?: Error) => void) {\n    this.raw(getMessageBytes[Protocol.ERROR](code, message), undefined, cb);\n  }\n\n  public leave(code?: number, data?: string) {\n    if (this.readyState !== ReadyState.OPEN) {\n      // connection already closed. ignore.\n      return;\n    }\n\n    this.readyState = ReadyState.CLOSING;\n\n    if (code !== undefined) {\n      this._ref.ws.end(code, data);\n\n    } else {\n      this._ref.ws.close();\n    }\n  }\n\n  public close(code?: number, data?: string) {\n    console.warn('DEPRECATION WARNING: use client.leave() instead of client.close()');\n    try {\n      throw new Error();\n    } catch (e) {\n      console.log(e.stack);\n    }\n    this.leave(code, data);\n  }\n\n  public toJSON() {\n    return { sessionId: this.sessionId, readyState: this.readyState };\n  }\n}\n"],"names":[],"mappings":"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"}