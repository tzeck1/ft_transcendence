{"version":3,"file":"uWebSocketsTransport.js","sources":["../src/uWebSocketsTransport.ts"],"sourcesContent":["import http from 'http';\nimport querystring from 'querystring';\nimport uWebSockets from 'uWebSockets.js';\n\nimport { DummyServer, ErrorCode, matchMaker, Transport, debugAndPrintError, spliceOne } from '@colyseus/core';\nimport { uWebSocketClient, uWebSocketWrapper } from './uWebSocketClient';\n\nexport type TransportOptions = Omit<uWebSockets.WebSocketBehavior, \"upgrade\" | \"open\" | \"pong\" | \"close\" | \"message\">;\n\ntype RawWebSocketClient = uWebSockets.WebSocket & {\n  headers: {[key: string]: string},\n  connection: { remoteAddress: string },\n};\n\nexport class uWebSocketsTransport extends Transport {\n    public app: uWebSockets.TemplatedApp;\n\n    protected clients: RawWebSocketClient[] = [];\n    protected clientWrappers = new WeakMap<RawWebSocketClient, uWebSocketWrapper>();\n\n    private _listeningSocket: any;\n\n    constructor(options: TransportOptions = {}, appOptions: uWebSockets.AppOptions = {}) {\n        super();\n\n        this.app = (appOptions.cert_file_name && appOptions.key_file_name)\n            ? uWebSockets.SSLApp(appOptions)\n            : uWebSockets.App(appOptions);\n\n        if (!options.maxBackpressure) {\n            options.maxBackpressure = 1024 * 1024;\n        }\n\n        if (!options.compression) {\n            options.compression = uWebSockets.DISABLED;\n        }\n\n        if (!options.maxPayloadLength) {\n            options.maxPayloadLength = 1024 * 1024;\n        }\n\n        // https://github.com/colyseus/colyseus/issues/458\n        // Adding a mock object for Transport.server\n        if(!this.server) {\n          this.server = new DummyServer();\n        }\n\n        this.app.ws('/*', {\n            ...options,\n\n            upgrade: (res, req, context) => {\n                // get all headers\n                const headers: {[id: string]: string} = {};\n                req.forEach((key, value) => headers[key] = value);\n\n                /* This immediately calls open handler, you must not use res after this call */\n                /* Spell these correctly */\n                res.upgrade(\n                    {\n                        url: req.getUrl(),\n                        query: req.getQuery(),\n\n                        // compatibility with @colyseus/ws-transport\n                        headers,\n                        connection: {\n                          remoteAddress: Buffer.from(res.getRemoteAddressAsText()).toString()\n                        }\n                    },\n                    req.getHeader('sec-websocket-key'),\n                    req.getHeader('sec-websocket-protocol'),\n                    req.getHeader('sec-websocket-extensions'),\n                    context\n                );\n            },\n\n            open: async (ws: RawWebSocketClient) => {\n                // ws.pingCount = 0;\n                await this.onConnection(ws);\n            },\n\n            // pong: (ws: RawWebSocketClient) => {\n            //     ws.pingCount = 0;\n            // },\n\n            close: (ws: RawWebSocketClient, code: number, message: ArrayBuffer) => {\n                // remove from client list\n                spliceOne(this.clients, this.clients.indexOf(ws));\n\n                const clientWrapper = this.clientWrappers.get(ws);\n                if (clientWrapper) {\n                  this.clientWrappers.delete(ws);\n\n                  // emit 'close' on wrapper\n                  clientWrapper.emit('close', code);\n                }\n            },\n\n            message: (ws: RawWebSocketClient, message: ArrayBuffer, isBinary: boolean) => {\n                // emit 'close' on wrapper\n                this.clientWrappers.get(ws)?.emit('message', Buffer.from(message.slice(0)));\n            },\n\n        });\n\n        this.registerMatchMakeRequest();\n    }\n\n    public listen(port: number, hostname?: string, backlog?: number, listeningListener?: () => void) {\n        this.app.listen(port, (listeningSocket: any) => {\n          this._listeningSocket = listeningSocket;\n          listeningListener?.();\n          this.server.emit(\"listening\"); // Mocking Transport.server behaviour, https://github.com/colyseus/colyseus/issues/458\n        });\n        return this;\n    }\n\n    public shutdown() {\n        if (this._listeningSocket) {\n          uWebSockets.us_listen_socket_close(this._listeningSocket);\n          this.server.emit(\"close\"); // Mocking Transport.server behaviour, https://github.com/colyseus/colyseus/issues/458\n        }\n    }\n\n    public simulateLatency(milliseconds: number) {\n        const originalRawSend = uWebSocketClient.prototype.raw;\n        uWebSocketClient.prototype.raw = function() {\n          setTimeout(() => originalRawSend.apply(this, arguments), milliseconds);\n        }\n    }\n\n    protected async onConnection(rawClient: RawWebSocketClient) {\n        const wrapper = new uWebSocketWrapper(rawClient);\n        // keep reference to client and its wrapper\n        this.clients.push(rawClient);\n        this.clientWrappers.set(rawClient, wrapper);\n\n        const query = rawClient.query;\n        const url = rawClient.url;\n\n        const sessionId = querystring.parse(query).sessionId as string;\n        const processAndRoomId = url.match(/\\/[a-zA-Z0-9_\\-]+\\/([a-zA-Z0-9_\\-]+)$/);\n        const roomId = processAndRoomId && processAndRoomId[1];\n\n        const room = matchMaker.getRoomById(roomId);\n        const client = new uWebSocketClient(sessionId, wrapper);\n\n        //\n        // TODO: DRY code below with all transports\n        //\n\n        try {\n            if (!room || !room.hasReservedSeat(sessionId)) {\n                throw new Error('seat reservation expired.');\n            }\n\n            await room._onJoin(client, rawClient as unknown as http.IncomingMessage);\n\n        } catch (e) {\n            debugAndPrintError(e);\n\n            // send error code to client then terminate\n            client.error(e.code, e.message, () => rawClient.close());\n        }\n    }\n\n    protected registerMatchMakeRequest() {\n        const headers = {\n            'Access-Control-Allow-Headers': 'Origin, X-Requested-With, Content-Type, Accept',\n            'Access-Control-Allow-Methods': 'OPTIONS, POST, GET',\n            'Access-Control-Allow-Origin': '*',\n            'Access-Control-Max-Age': 2592000,\n            // ...\n        };\n\n        // TODO: DRY with Server.ts\n        const matchmakeRoute = 'matchmake';\n        const allowedRoomNameChars = /([a-zA-Z_\\-0-9]+)/gi;\n\n        const writeHeaders = (res: uWebSockets.HttpResponse) => {\n            // skip if aborted\n            if (res.aborted) { return; }\n\n            for (const header in headers) {\n                res.writeHeader(header, headers[header].toString());\n            }\n\n            return true;\n        }\n\n        const writeError = (res: uWebSockets.HttpResponse, error: { code: number, error: string }) => {\n            // skip if aborted\n            if (res.aborted) { return; }\n\n            res.writeStatus(\"406 Not Acceptable\");\n            res.end(JSON.stringify(error));\n        }\n\n        const onAborted = (res: uWebSockets.HttpResponse) => {\n          res.aborted = true;\n        };\n\n        this.app.options(\"/matchmake/*\", (res, req) => {\n            res.onAborted(() => onAborted(res));\n\n            if (writeHeaders(res)) {\n              res.writeStatus(\"204 No Content\");\n              res.end();\n            }\n        });\n\n        this.app.post(\"/matchmake/*\", (res, req) => {\n            res.onAborted(() => onAborted(res));\n\n            writeHeaders(res);\n            res.writeHeader('Content-Type', 'application/json');\n\n            const url = req.getUrl();\n            const matchedParams = url.match(allowedRoomNameChars);\n            const matchmakeIndex = matchedParams.indexOf(matchmakeRoute);\n\n            // read json body\n            this.readJson(res, async (clientOptions) => {\n                try {\n                    if (clientOptions === undefined) {\n                        throw new Error(\"invalid JSON input\");\n                    }\n\n                    const method = matchedParams[matchmakeIndex + 1];\n                    const name = matchedParams[matchmakeIndex + 2] || '';\n                    const response = await matchMaker.controller.invokeMethod(method, name, clientOptions);\n                    if (!res.aborted) {\n                      res.writeStatus(\"200 OK\");\n                      res.end(JSON.stringify(response));\n                    }\n\n                } catch (e) {\n                    debugAndPrintError(e);\n                    writeError(res, {\n                        code: e.code || ErrorCode.MATCHMAKE_UNHANDLED,\n                        error: e.message\n                    });\n                }\n\n            });\n        });\n\n        // this.app.any(\"/*\", (res, req) => {\n        //     res.onAborted(() => onAborted(req));\n        //     res.writeStatus(\"200 OK\");\n        // });\n\n        this.app.get(\"/matchmake/*\", async (res, req) => {\n            res.onAborted(() => onAborted(res));\n\n            writeHeaders(res);\n            res.writeHeader('Content-Type', 'application/json');\n\n            const url = req.getUrl();\n            const matchedParams = url.match(allowedRoomNameChars);\n            const roomName = matchedParams.length > 1 ? matchedParams[matchedParams.length - 1] : \"\";\n\n            try {\n                const response = await matchMaker.controller.getAvailableRooms(roomName || '')\n                if (!res.aborted) {\n                  res.writeStatus(\"200 OK\");\n                  res.end(JSON.stringify(response));\n                }\n\n            } catch (e) {\n                debugAndPrintError(e);\n                writeError(res, {\n                    code: e.code || ErrorCode.MATCHMAKE_UNHANDLED,\n                    error: e.message\n                });\n            }\n        });\n    }\n\n    /* Helper function for reading a posted JSON body */\n    /* Extracted from https://github.com/uNetworking/uWebSockets.js/blob/master/examples/JsonPost.js */\n    private readJson(res: uWebSockets.HttpResponse, cb: (json: any) => void) {\n        let buffer: any;\n        /* Register data cb */\n        res.onData((ab, isLast) => {\n            let chunk = Buffer.from(ab);\n            if (isLast) {\n                let json;\n                if (buffer) {\n                    try {\n                        // @ts-ignore\n                        json = JSON.parse(Buffer.concat([buffer, chunk]));\n                    } catch (e) {\n                        /* res.close calls onAborted */\n                        // res.close();\n                        cb(undefined);\n                        return;\n                    }\n                    cb(json);\n                } else {\n                    try {\n                        // @ts-ignore\n                        json = JSON.parse(chunk);\n                    } catch (e) {\n                        /* res.close calls onAborted */\n                        // res.close();\n                        cb(undefined);\n                        return;\n                    }\n                    cb(json);\n                }\n            } else {\n                if (buffer) {\n                    buffer = Buffer.concat([buffer, chunk]);\n                } else {\n                    buffer = Buffer.concat([chunk]);\n                }\n            }\n        });\n    }\n}\n"],"names":["Transport","uWebSockets","DummyServer","spliceOne","uWebSocketClient","uWebSocketWrapper","querystring","matchMaker","debugAndPrintError","ErrorCode"],"mappings":"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"}